<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>트레이딩 앱 — Live</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lightweight-charts/dist/lightweight-charts.standalone.production.js"></script>
  <style>
    .kbd{border:1px solid#475569;border-bottom-width:3px;padding:2px 6px;border-radius:6px;font-weight:600;font-size:12px}
    .up{color:#ef4444}.down{color:#3b82f6}.blink{animation:blink .6s linear 2}@keyframes blink{50%{opacity:.3}}
  </style>
</head>
<body class="bg-slate-950 text-slate-100">
  <div class="flex h-screen">
    <aside class="w-80 p-4 border-r border-slate-800">
      <div class="flex items-center gap-2 mb-4">
        <div class="text-xl font-bold">트레이딩 앱</div>
        <span class="text-[10px] px-2 py-0.5 bg-slate-800 rounded-full">LIVE</span>
      </div>

      <input id="search" placeholder="종목코드/이름 검색 (예: 005930, 삼성전자)" class="w-full px-3 py-2 bg-slate-900 rounded border border-slate-700 outline-none focus:border-pink-500">
      <div id="search-results" class="space-y-1 max-h-48 overflow-auto mt-2"></div>

      <div class="mt-6">
        <div class="flex items-center justify-between">
          <h3 class="font-semibold">관심종목</h3><div class="text-xs text-slate-400">F6</div>
        </div>
        <div id="watchlist" class="mt-2 space-y-1 max-h-64 overflow-auto"></div>
      </div>

      <div class="mt-6 text-xs text-slate-400 space-y-1">
        <div><span class="kbd">F5</span> 차트 • <span class="kbd">F6</span> 관심 • <span class="kbd">F7</span> 보유 • <span class="kbd">F8</span> 주문 • <span class="kbd">F9</span> 뉴스</div>
        <div>심볼 클릭: 선택 • ★: 관심토글</div>
      </div>
    </aside>

    <main class="flex-1 p-4 overflow-auto">
      <div class="grid grid-cols-3 gap-4">
        <section class="col-span-3 lg:col-span-2">
          <div class="flex items-center justify-between mb-2">
            <h2 class="text-lg font-semibold">상위 10개 종목</h2>
            <div class="text-xs text-slate-400" id="connection">연결중...</div>
          </div>
          <div id="top10" class="grid grid-cols-2 md:grid-cols-3 xl:grid-cols-5 gap-2"></div>
        </section>

        <section class="col-span-3 lg:col-span-1">
          <div class="bg-slate-900 rounded-xl p-3 shadow">
            <div class="text-sm font-semibold mb-2">주문 (F8)</div>
            <div class="space-y-2">
              <input id="ord-symbol" class="w-full px-2 py-1 bg-slate-800 rounded" placeholder="심볼 (예: 005930)">
              <input id="ord-qty" class="w-full px-2 py-1 bg-slate-800 rounded" type="number" placeholder="수량">
              <div class="flex gap-2">
                <button id="btn-buy" class="flex-1 bg-rose-600 hover:bg-rose-700 rounded px-3 py-2">매수</button>
                <button id="btn-sell" class="flex-1 bg-blue-600 hover:bg-blue-700 rounded px-3 py-2">매도</button>
              </div>
              <div id="ord-result" class="text-xs text-slate-400"></div>
            </div>
          </div>

          <div class="bg-slate-900 rounded-xl p-3 shadow mt-3">
            <div class="text-sm font-semibold mb-2">보유 현황 (F7)</div>
            <div id="portfolio" class="text-sm"></div>
          </div>
        </section>

        <section class="col-span-3">
          <div class="bg-slate-900 rounded-xl p-3 shadow">
            <div class="flex items-center justify-between">
              <div class="text-sm font-semibold">차트 (F5)</div>
              <div id="chart-symbol" class="text-xs text-slate-400"></div>
            </div>
            <div id="chart" style="height: 340px;" class="mt-2"></div>
          </div>
        </section>

        <section class="col-span-3">
          <div class="bg-slate-900 rounded-xl p-3 shadow">
            <div class="flex items-center justify-between">
              <div class="text-sm font-semibold">뉴스 (F9)</div>
              <div class="text-xs text-slate-400">선택 심볼/검색어 기준</div>
            </div>
            <div id="news" class="mt-2 grid md:grid-cols-2 gap-3"></div>
          </div>
        </section>
      </div>
    </main>
  </div>

  <template id="tpl-card">
    <div class="bg-slate-900 rounded-xl p-3 shadow cursor-pointer hover:ring-1 hover:ring-pink-500">
      <div class="flex items-center justify-between">
        <div class="font-semibold sym"></div>
        <button class="text-yellow-400" title="관심토글">★</button>
      </div>
      <div class="name text-xs text-slate-400"></div>
      <div class="flex items-end gap-2 mt-2">
        <div class="price text-xl font-bold"></div>
        <div class="chg text-sm"></div>
      </div>
      <div class="vol text-xs text-slate-400"></div>
    </div>
  </template>

  <script>
    const $=(s,p=document)=>p.querySelector(s), $$=(s,p=document)=>Array.from(p.querySelectorAll(s));
    const n=v=>Number(v).toLocaleString('ko-KR'); const pct=v=>(v>0?'+':'')+Number(v).toFixed(2)+'%';
    let selectedSymbol="005930"; let topSymbols=[]; let es=null; let chart,series; let watch=new Set();

    function card(q){
      const t=$('#tpl-card').content.firstElementChild.cloneNode(true);
      t.querySelector('.sym').textContent=q.symbol; t.querySelector('.name').textContent=q.name||''; t.querySelector('.price').textContent=n(q.price||0);
      const chg=t.querySelector('.chg'); const sign=(q.pct||0)>=0?'up':'down'; chg.className='chg text-sm '+sign; chg.textContent=`${(q.change>0?'+':'')+(q.change||0)} (${pct(q.pct||0)})`;
      t.querySelector('.vol').textContent='거래량 '+n(q.volume||0);
      t.addEventListener('click',()=>selectSymbol(q.symbol,q.name));
      t.querySelector('button').addEventListener('click',e=>{e.stopPropagation(); toggleWatch(q.symbol);});
      return t;
    }

    async function loadTop(){
      const res=await fetch('/api/top10'); const arr=await res.json(); topSymbols=arr.map(a=>a.symbol);
      const box=$('#top10'); box.innerHTML=''; arr.forEach(q=>box.appendChild(card(q))); openStream(); selectSymbol(arr[0].symbol,arr[0].name);
    }
    function openStream(){
      if (es) es.close(); $('#connection').textContent='연결중...';
      es=new EventSource('/api/stream/prices?symbols='+topSymbols.join(','));
      es.addEventListener('quotes',ev=>{
        $('#connection').textContent='실시간';
        const payload=JSON.parse(ev.data); const by=Object.fromEntries(payload.data.map(x=>[x.symbol,x]));
        $$('#top10 > div').forEach(div=>{
          const sym=div.querySelector('.sym').textContent; const q=by[sym]; if (!q) return;
          const price=div.querySelector('.price'); price.textContent=n(q.price); price.classList.add('blink'); setTimeout(()=>price.classList.remove('blink'),400);
          const chg=div.querySelector('.chg'); chg.textContent=`${(q.change>0?'+':'')+q.change} (${pct(q.pct)})`; chg.className='chg text-sm '+((q.pct||0)>=0?'up':'down');
          div.querySelector('.vol').textContent='거래량 '+n(q.volume||0);
        });
      }); es.onerror=()=>$('#connection').textContent='재연결...';
    }
    async function selectSymbol(sym,name){
      selectedSymbol=sym; $('#chart-symbol').textContent=`${sym} ${name||''}`;
      const res=await fetch('/api/candles?symbol='+sym+'&minutes=120'); const data=await res.json(); ensureChart();
      series.setData(data.map(c=>({time:c.time,open:c.open,high:c.high,low:c.low,close:c.close})));
    }
    function ensureChart(){
      if (chart) return;
      chart=LightweightCharts.createChart($('#chart'),{layout:{background:{type:'solid',color:'#0f172a'},textColor:'#e2e8f0'},grid:{vertLines:{color:'#1e293b'},horzLines:{color:'#1e293b'}},timeScale:{timeVisible:true,secondsVisible:false},rightPriceScale:{borderColor:'#334155'}});
      series=chart.addCandlestickSeries({upColor:'#ef4444',downColor:'#3b82f6',borderUpColor:'#ef4444',borderDownColor:'#3b82f6',wickUpColor:'#ef4444',wickDownColor:'#3b82f6'});
    }

    // search
    $('#search').addEventListener('input', async (e)=>{
      const q=e.target.value.trim(); const box=$('#search-results'); if (!q){ box.innerHTML=''; return; }
      const res=await fetch('/api/search?q='+encodeURIComponent(q)); const arr=await res.json(); box.innerHTML='';
      arr.forEach(s=>{
        const item=document.createElement('div'); item.className='px-2 py-1 rounded hover:bg-slate-800 cursor-pointer flex justify-between';
        item.innerHTML=`<span>${s.symbol} ${s.name}</span><button class="text-yellow-400">★</button>`;
        item.addEventListener('click',()=>selectSymbol(s.symbol,s.name));
        item.querySelector('button').addEventListener('click',(ev)=>{ev.stopPropagation(); toggleWatch(s.symbol);});
        box.appendChild(item);
      });
    });

    // watchlist
    async function loadWatch(){ const r=await fetch('/api/watchlist'); watch=new Set(await r.json()); renderWatch(); }
    function renderWatch(){
      const box=$('#watchlist'); box.innerHTML=''; if (watch.size===0){ box.innerHTML='<div class="text-xs text-slate-500">★로 추가하세요</div>'; return; }
      watch.forEach(sym=>{
        const row=document.createElement('div'); row.className='flex items-center justify-between bg-slate-900 rounded px-2 py-1';
        row.innerHTML=`<span class="cursor-pointer">${sym}</span><button class="text-yellow-400">★</button>`;
        row.querySelector('span').addEventListener('click',()=>selectSymbol(sym));
        row.querySelector('button').addEventListener('click',()=>removeWatch(sym));
        box.appendChild(row);
      });
    }
    async function toggleWatch(sym){ if (watch.has(sym)) return removeWatch(sym); await fetch('/api/watchlist/'+sym,{method:'POST'}); loadWatch(); }
    async function removeWatch(sym){ await fetch('/api/watchlist/'+sym,{method:'DELETE'}); loadWatch(); }

    // orders
    $('#btn-buy').addEventListener('click',()=>order('BUY')); $('#btn-sell').addEventListener('click',()=>order('SELL'));
    async function order(side){
      const symbol=$('#ord-symbol').value||selectedSymbol; const qty=parseInt($('#ord-qty').value||'0',10);
      if (!symbol||!qty){ $('#ord-result').textContent='심볼/수량 확인'; return; }
      const res=await fetch('/api/order',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({side,symbol,quantity:qty,price:0})});
      const json=await res.json(); $('#ord-result').textContent=json.result; loadPortfolio();
    }
    async function loadPortfolio(){
      const r=await fetch('/api/portfolio'); const p=await r.json(); const box=$('#portfolio'); let html=`<div>현금: ${n(p.cash)}원</div>`;
      if (Object.keys(p.positions).length===0) html+='<div class="text-xs text-slate-500 mt-1">보유 종목 없음</div>';
      html+='<div class="mt-2 space-y-1">'; for (const [sym,pos] of Object.entries(p.positions)){ html+=`<div class="flex justify-between bg-slate-800 rounded px-2 py-1"><div>${sym} • ${pos.quantity}주</div><div>@ ${n(pos.avgPrice)}</div></div>`; } html+='</div>'; box.innerHTML=html;
    }

    // news
    async function loadNews(q){
      const box=$('#news'); box.innerHTML='';
      try{
        const r=await fetch('/api/news?query='+encodeURIComponent(q||selectedSymbol));
        if (!r.ok){ box.innerHTML='<div class="text-xs text-slate-500">뉴스 API 키가 설정되지 않았습니다.</div>'; return; }
        const arr=await r.json(); if (!arr.length){ box.innerHTML='<div class="text-xs text-slate-500">뉴스 없음</div>'; return; }
        arr.forEach(nw=>{ const a=document.createElement('a'); a.target='_blank'; a.href=nw.url; a.className='block p-3 rounded bg-slate-800 hover:bg-slate-700';
          a.innerHTML=`<div class="text-sm font-semibold">${nw.title}</div><div class="text-xs text-slate-400 mt-1">${nw.source||''}</div>`; box.appendChild(a); });
      }catch(e){ box.innerHTML='<div class="text-xs text-slate-500">뉴스 로딩 실패</div>'; }
    }

    // hotkeys
    window.addEventListener('keydown',(e)=>{
      if (e.key==='F5'){ e.preventDefault(); $('#chart').scrollIntoView({behavior:'smooth'}); }
      if (e.key==='F6'){ e.preventDefault(); $('#watchlist').scrollIntoView({behavior:'smooth'}); }
      if (e.key==='F7'){ e.preventDefault(); $('#portfolio').scrollIntoView({behavior:'smooth'}); }
      if (e.key==='F8'){ e.preventDefault(); $('#ord-symbol').focus(); }
      if (e.key==='F9'){ e.preventDefault(); $('#news').scrollIntoView({behavior:'smooth'}); loadNews(selectedSymbol); }
    });

    loadTop(); loadWatch(); loadPortfolio();
  </script>
</body>
</html>
