<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>주식 가상거래소</title>
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif; margin:0; background:#0b0f14; color:#e6edf3; }
    header { background:#0b0f14; border-bottom:1px solid #1f2a35; padding:12px 16px; position:sticky; top:0; }
    h1 { margin:0; font-size:18px; }
    .layout { display:grid; grid-template-columns: 320px 1fr; gap:12px; padding:16px; }
    .card { background:#0f1620; border:1px solid #1f2a35; border-radius:14px; padding:12px; }
    .row { display:flex; align-items:center; justify-content:space-between; padding:8px 4px; border-bottom:1px dashed #1f2a35; cursor:pointer; }
    .row:last-child{ border-bottom:none; }
    .sym { font-weight:700; letter-spacing:0.4px; }
    .up { color:#28c76f; } .down{ color:#ea5455; }
    input, button { background:#0b0f14; color:#e6edf3; border:1px solid #1f2a35; border-radius:10px; padding:8px 10px; }
    input { flex:1; }
    button { cursor:pointer; }
    .kbd { background:#101821; border:1px solid #223344; border-radius:8px; padding:2px 6px; font-size:12px; }
    .toolbar { display:flex; gap:8px; align-items:center; }
    canvas { width:100%; height:320px; background:#0b0f14; border:1px solid #1f2a35; border-radius:12px; }
    a { color:#9ecbff; text-decoration:none; }
    .grid2 { display:grid; grid-template-columns:1fr 1fr; gap:12px; }
    small { color:#9aa7b0; }
  </style>
</head>
<body>
  <header>
    <h1>주식 가상거래소 — <span class="kbd">F5</span> 차트 · <span class="kbd">F6</span> 관심 · <span class="kbd">F7</span> 보유 · <span class="kbd">F8</span> 뉴스</h1>
  </header>
  <div class="layout">
    <aside class="card">
      <h3>상위 10</h3>
      <div id="top10"></div>
    </aside>
    <main class="card">
      <div class="toolbar">
        <input id="symbolInput" placeholder="종목코드 (예: AAPL, MSFT, NVDA)" />
        <button id="addBtn">관심+</button>
      </div>
      <div style="margin:10px 0;"><span class="kbd">F5</span> 차트, <span class="kbd">F6</span> 관심, <span class="kbd">F7</span> 보유, <span class="kbd">F8</span> 뉴스</div>
      <div id="view"></div>
    </main>
  </div>

<script>
const API = location.origin;
let activeSymbol = "AAPL";
let activeView = "chart"; // chart | watch | hold | news
let watch = JSON.parse(localStorage.getItem("watch")||"[]");
let hold = JSON.parse(localStorage.getItem("hold")||"[]");
let prices = {};

const fmt = n => (n>=0?"+":"") + n.toFixed(2);
const el = id => document.getElementById(id);

async function fetchTop10(){
  try {
    const r = await fetch(API + "/api/top10");
    const data = await r.json();
    const box = el("top10");
    box.innerHTML = "";
    data.forEach(q=>{
      const row = document.createElement("div");
      row.className = "row";
      row.innerHTML = `<div class="sym">${q.symbol}</div>
                       <div class="${q.change>=0?'up':'down'}">${q.price?.toFixed(2)} <small>${fmt(q.change)}</small></div>`;
      row.onclick = ()=>{ activeSymbol = q.symbol; activeView="chart"; renderView(); };
      box.appendChild(row);
      pushPrice(q.symbol, q.price);
    });
  } catch(e){ console.error(e); }
}

async function fetchQuote(sym){
  try{
    const r = await fetch(API + "/api/quote?symbol="+encodeURIComponent(sym));
    return await r.json();
  }catch(e){return null;}
}

async function pollActive(){
  const q = await fetchQuote(activeSymbol);
  if (q && q.price) pushPrice(q.symbol, q.price);
}

function pushPrice(sym, price){
  if (price==null) return;
  if (!prices[sym]) prices[sym] = [];
  prices[sym].push({t:Date.now(), p:price});
  if (prices[sym].length > 900) prices[sym].shift();
  if (activeView==="chart" && sym===activeSymbol) drawChart(sym);
}

function drawChart(sym){
  const c = document.getElementById("chart");
  if (!c) return;
  const ctx = c.getContext("2d");
  const w = c.width = c.clientWidth;
  const h = c.height = 320;
  c.height = h;
  ctx.clearRect(0,0,w,h);
  const arr = prices[sym]||[];
  if (arr.length < 2) return;
  const min = Math.min(...arr.map(d=>d.p));
  const max = Math.max(...arr.map(d=>d.p));
  const xs = i => i/(arr.length-1) * w;
  const ys = p => h - (p-min)/(max-min+1e-6)*h;
  ctx.beginPath();
  ctx.moveTo(xs(0), ys(arr[0].p));
  for (let i=1;i<arr.length;i++){ ctx.lineTo(xs(i), ys(arr[i].p)); }
  ctx.strokeStyle = "#9ecbff";
  ctx.lineWidth = 2;
  ctx.stroke();
}

function addWatch(){
  const v = el("symbolInput").value.trim().toUpperCase();
  if (!v) return;
  if (!watch.includes(v)) watch.push(v);
  localStorage.setItem("watch", JSON.stringify(watch));
  activeView = "watch"; renderView();
}

async function renderView(){
  const root = el("view");
  if (activeView === "chart"){
    root.innerHTML = `<h3>${activeSymbol} 차트</h3><canvas id="chart"></canvas>`;
    drawChart(activeSymbol);
  } else if (activeView === "watch"){
    root.innerHTML = `<h3>관심종목</h3><div id="watchList"></div>`;
    const box = el("watchList");
    box.innerHTML = "";
    for (const s of watch){
      const q = await fetchQuote(s);
      if (!q) continue;
      const row = document.createElement("div");
      row.className = "row";
      row.innerHTML = `<div class="sym">${q.symbol}</div>
        <div class="${q.change>=0?'up':'down'}">${q.price?.toFixed(2)} <small>${fmt(q.change)}</small></div>`;
      row.onclick = ()=>{ activeSymbol = q.symbol; activeView = "chart"; renderView(); };
      box.appendChild(row);
      pushPrice(q.symbol, q.price);
    }
  } else if (activeView === "hold"){
    root.innerHTML = `<h3>보유</h3><p>데모: 아직 매수/매도 구현 전.</p>`;
  } else if (activeView === "news"){
    root.innerHTML = `<h3>${activeSymbol} 뉴스</h3><div id="newsBox">로딩...</div>`;
    const r = await fetch(API + "/api/news?q=" + encodeURIComponent(activeSymbol));
    const items = await r.json();
    const box = el("newsBox");
    box.innerHTML = items.map(n=>`<div class="row"><div>${n.title} <br/><small>${n.publisher||''} · ${n.pubDate||''}</small></div><div><a href="${n.link}" target="_blank">열기</a></div></div>`).join('');
  }
}

document.addEventListener("keydown", (e)=>{
  if (e.key === "F5"){ e.preventDefault(); activeView="chart"; renderView(); }
  if (e.key === "F6"){ e.preventDefault(); activeView="watch"; renderView(); }
  if (e.key === "F7"){ e.preventDefault(); activeView="hold"; renderView(); }
  if (e.key === "F8"){ e.preventDefault(); activeView="news"; renderView(); }
});
el("addBtn").onclick = addWatch;

// init
renderView();
fetchTop10();
setInterval(fetchTop10, 5000);
setInterval(pollActive, 1000);
</script>
</body>
</html>
